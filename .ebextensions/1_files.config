files:
    "/etc/nginx/conf.d/00_elastic_beanstalk_proxy.conf":
        mode: "000755"
        owner: root
        group: root
        content: |
            server {
                 server_name avalanche.ca;
                 return 301 $scheme://www.avalanche.ca$request_uri;
            }

            server {
                listen 8080;
                client_max_body_size 20M;
                #server_name www.avalanche.ca;

                location /assets {
                    rewrite /assets/$ /index.html break;
                    rewrite /assets$ /index.html break;
                    rewrite /assets/(.*) /$1  break;
                    proxy_pass            https://ac-assets.s3.amazonaws.com;
                }

                location /fxresources {
                    rewrite /fxresources/(.*) /$1 break;
                    proxy_pass       https://avalancheca-assets.s3.amazonaws.com;
                    #proxy_set_header Host $host;
                }

                location / {
                    rewrite \/cac\/bulletins\/latest\/(.*) /forecasts/$1 redirect;
                    rewrite \/cac\/bulletins\/latest$ / redirect;
                    rewrite \/cac\/forecasts\/$ / redirect;
                    rewrite \/cac\/(.*)$ /$1 redirect;
                    rewrite \/cac$ / redirect;
                    rewrite \/caf$ /foundation redirect;
                    rewrite \/caa$ http://www.avalancheassociation.ca/ redirect;

                    proxy_pass  http://nodejs;
                    proxy_set_header   Connection "";
                    proxy_http_version 1.1;
                    proxy_set_header        Host            $host;
                    proxy_set_header        X-Real-IP       $remote_addr;
                    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
                }

            }
    "/etc/rsyslog.d/22-loggly.conf":
        mode: "000755"
        owner: root
        group: root
        content: |
            $template LogglyFormat,"<%pri%>%protocol-version% %timestamp:::date-rfc3339% %HOSTNAME% %app-name% %procid% %msgid% [3c69f1b6-85f4-4940-b1f2-a00a6a1999b3@41058] %msg%\n"
            *.* @@logs-01.loggly.com:514;LogglyFormat
    "/etc/rsyslog.d/22-papertrail.conf":
        mode: "000755"
        owner: root
        group: root
        content: |
            $template LogglyFormat,"<%pri%>%protocol-version% %timestamp:::date-rfc3339% %HOSTNAME% %app-name% %procid% %msgid% [3c69f1b6-85f4-4940-b1f2-a00a6a1999b3@41058] %msg%\n"
            *.* @logs2.papertrailapp.com:49854
    "/etc/rsyslog.d/21-filemonitoring-loggly.conf":
        mode: "000755"
        owner: root
        group: root
        content: |
            $ModLoad imfile
            $InputFilePollInterval 10
            $PrivDropToGroup adm
            $WorkDirectory /var/spool/rsyslog

            # nginx access file:
            $InputFileName /var/log/nginx/access.log
            $InputFileTag nginx-access:
            $InputFileStateFile stat-nginx-access
            $InputFileSeverity info
            $InputFilePersistStateInterval 20000
            $InputRunFileMonitor

            #nginx Error file:
            $InputFileName /var/log/nginx/error.log
            $InputFileTag nginx-error:
            $InputFileStateFile stat-nginx-error
            $InputFileSeverity error
            $InputFilePersistStateInterval 20000
            $InputRunFileMonitor

            #nodejs logs
            $InputFileName /var/log/nodejs/nodejs.log
            $InputFileTag nodejs-log:
            $InputFileStateFile stat-nodejs-log
            $InputFileSeverity error
            $InputFilePersistStateInterval 20000
            $InputRunFileMonitor

            #Add a tag for nginx events
            $template LogglyFormat,"<%pri%>%protocol-version% %timestamp:::date-rfc3339% %HOSTNAME% %app-name% %procid% %msgid% [3c69f1b6-85f4-4940-b1f2-a00a6a1999b3@41058 tag=\"nginx\"] %msg%\n"

            if $programname == 'nginx-access' then @@logs-01.loggly.com:514;LogglyFormat
            if $programname == 'nginx-access' then ~
            if $programname == 'nginx-error' then @@logs-01.loggly.com:514;LogglyFormat
            if $programname == 'nginx-error' then ~
            if $programname == 'nodejs-log' then @@logs-01.loggly.com:514;LogglyFormat
            if $programname == 'nodejs-log' then ~
